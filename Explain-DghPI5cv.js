const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StudyMindMap-ClTJ6Msu.js","./vendor-ui-ARy-o6ek.js","./index-CVOPyXAZ.js","./vendor-charts-msDMqvam.js","./vendor-supabase-Djqvfl2V.js","./vendor-motion-D4ajpNSI.js","./index-D3uVj_lc.css","./MarkdownView-N1CXs6cB.js","./vendor-markdown-PAa2EYla.js"])))=>i.map(i=>d[i]);
import{r as o,j as e,w as W,a9 as q,W as K,aa as J,ab as X,ac as Y,ad as H,s as Q}from"./vendor-ui-ARy-o6ek.js";import{i as _,g as v,e as z,t as p,R as Z,T as R,U as ee,V as ae,W as se,C as E,a as A,b as D,B as j,c as L,d as O,I as te,_ as T,u as ne,D as ie,A as re,S as oe}from"./index-CVOPyXAZ.js";import{g as V}from"./gemini-study-pack-CLczGIFe.js";import{a as ce,c as de}from"./gemini-chat-CizPHIUd.js";import{S as le}from"./scroll-area-hR7LJ1HF.js";import{S as b}from"./skeleton-I8iu4Y_S.js";import{A as M}from"./AdUnit-DLxwGZFG.js";import{L as me}from"./LoadingSpinner-BXeLHAwc.js";import"./vendor-charts-msDMqvam.js";import"./vendor-supabase-Djqvfl2V.js";import"./vendor-motion-D4ajpNSI.js";async function ue(s){const a=_();if(!a)throw new Error("خطأ في الإعدادات: Supabase غير مُفعّل على السيرفر");const t=s.fileId||null,x=s.extractedText||"",l=async d=>{const{data:f,error:w}=await a.functions.invoke("generate-study-content",{body:{action:"explain",text:d,fileId:t}});return{data:f,error:w}};let n=await l(t?"":x);if(n.error){const d=String(n.error?.message||"");t&&x.trim()&&(d.includes("MISSING_TEXT_OR_RAG")||d.includes("400"))&&(n=await l(x))}if(n.error)throw new Error("فشل الاتصال بمركز الذكاء الاصطناعي");const m=n.data;if(!m?.markdown||!Array.isArray(m.questions))throw new Error("فشل الاتصال بمركز الذكاء الاصطناعي");return m}function xe(s,a,t="text/plain;charset=utf-8"){const x=new Blob([a],{type:t}),l=URL.createObjectURL(x),n=document.createElement("a");n.href=l,n.download=s,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(l)}function fe(s){return`${`${window.location.origin}${window.location.pathname}`}#${s.startsWith("/")?s:"/"+s}`}function ge(s){const a=o.useMemo(()=>{const c=String(s.fileIdFromRoute||"").trim(),i=sessionStorage.getItem("aass:active_file_id")||"",r=c||i;return c&&c!==i&&sessionStorage.setItem("aass:active_file_id",c),r},[s.fileIdFromRoute]),[t,x]=o.useState(sessionStorage.getItem("aass:last_uploaded_file_name")||"(لم يتم تحديد ملف بعد)"),[l,n]=o.useState("empty"),[m,d]=o.useState(""),f=l==="loading";o.useEffect(()=>{if(!a)return;const c=v(),i=_();!c||!z()||!i||(async()=>{try{const{data:r,error:u}=await i.from("files").select("id,name,content,analysis_markdown").eq("user_id",c.id).eq("id",a).maybeSingle();try{await i.from("files").update({last_opened_at:new Date().toISOString()}).eq("user_id",c.id).eq("id",a)}catch{}if(u)throw u;if(!r)throw new Error("FILE_NOT_FOUND");const g=String(r.name||"(ملف)");x(g),sessionStorage.setItem("aass:last_uploaded_file_name",g);const y=String(r.content||"");y.trim()&&sessionStorage.setItem(`aass:extracted:${a}`,y);const S=String(r.analysis_markdown||"").trim();S&&(d(S),n("ready"))}catch(r){console.error(r),p.error("الرابط غير صالح أو الملف غير موجود"),s.onInvalidFile?.()}})()},[a]),o.useEffect(()=>{const c=v();if(!a){n("empty"),d(`# اختر ملفاً أولاً

اذهب إلى **مكتبتي** واختر ملفاً ثم افتح صفحة الشرح.`);return}if(c){const r=Z(c,a);if(r?.markdown){d(r.markdown),n("ready"),R(c,a).then(u=>{u?.markdown&&d(u.markdown)});return}}if(c&&R(c,a).then(r=>{if(r?.markdown){d(r.markdown),n("ready");return}}),!V()){n("missing-ai"),d(`# الذكاء الاصطناعي غير مُفعل حالياً

لا يمكن تشغيل التحليل لأن خدمة السيرفر غير جاهزة.

- تأكد من نشر **Supabase Edge Function**: generate-study-content
- وتأكد من ضبط Secret: **GEMINI_API_KEY** داخل Supabase
`);return}const i=sessionStorage.getItem(`aass:extracted:${a}`)||"";n("loading"),ue({extractedText:i||void 0,fileId:a}).then(r=>{d(r.markdown),n("ready"),c&&ee(c,a,r)}).catch(()=>{n("empty"),d(`# تعذر التحليل

حاول مرة أخرى بعد دقائق.`)})},[a]);const w=o.useCallback(async()=>{if(!a)return;const c=fe(`/explain/${a}`);try{await navigator.clipboard.writeText(c),p.success("تم نسخ رابط الشرح")}catch{xe("explain-link.txt",c),p.message("لم أستطع نسخ الرابط تلقائياً — تم تنزيل ملف به الرابط")}},[a]);return{fileId:a,fileName:t,markdown:m,mode:l,isLoading:f,copyExplainLink:w}}function pe(s){const{fileId:a,fileName:t,aiDisabled:x}=s,[l,n]=o.useState(""),[m,d]=o.useState(!1);o.useEffect(()=>{if(!a){n("");return}const i=`aass:mindmap:${a}`,r=sessionStorage.getItem(i)||"";r.trim()&&n(r);const u=_();u&&(async()=>{try{const{data:g}=await u.from("files").select("mindmap_code").eq("id",a).maybeSingle(),y=String(g?.mindmap_code||"").trim();y&&(n(y),sessionStorage.setItem(i,y))}catch{}})()},[a]);const f=o.useCallback(async i=>{if(!a){p.error("لا يوجد ملف نشط لتوليد خريطة");return}const r=sessionStorage.getItem(`aass:extracted:${a}`)||"";if(!r.trim()){p.error("لا يوجد نص مستخرج لهذا الملف بعد");return}if(!V()||x){p.error("الذكاء الاصطناعي غير مُفعل حالياً");return}d(!0);try{const u=await ce({text:r,fileId:a,refresh:!!i?.refresh});n(u),sessionStorage.setItem(`aass:mindmap:${a}`,u),p.success(i?.refresh?"تم تحديث الخريطة الذهنية":"تم توليد الخريطة الذهنية")}catch{p.error(i?.refresh?"فشل تحديث الخريطة الذهنية":"فشل توليد الخريطة الذهنية")}finally{d(!1)}},[a,x]),w=o.useCallback(async()=>{if(l.trim())try{await navigator.clipboard.writeText(l),p.success("تم نسخ كود الخريطة")}catch{p.error("تعذر النسخ")}},[l]),c=o.useCallback(()=>{if(!l.trim())return;const i=t.replace(/[\\/:*?"<>|]+/g,"-"),r=new Blob([l],{type:"text/plain;charset=utf-8"}),u=URL.createObjectURL(r),g=document.createElement("a");g.href=u,g.download=`خريطة-${i}.mmd`,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(u),p.success("تم تحميل ملف Mermaid")},[l,t]);return{mindmapCode:l,mindmapLoading:m,buildMindMap:f,copyMindMapCode:w,downloadMindMap:c}}function $(s){return`aass:chat:${s.userId}:${s.fileId}`}function he(s){if(!s)return null;try{const a=JSON.parse(s);return Array.isArray(a)?a.filter(t=>t&&typeof t=="object").map(t=>({id:String(t.id||`m_${Math.random().toString(16).slice(2)}_${Date.now()}`),role:t.role==="user"?"user":"assistant",content:String(t.content||""),createdAt:Number(t.createdAt||Date.now())})).slice(-200):null}catch{return null}}function we(s){const{fileId:a,pageMarkdown:t,socraticMode:x,study_mode:l}=s,n=v(),m=z()&&!!n?.id,d=n?.id||"guest",f=a||"unknown",w=[{id:"m_welcome",role:"assistant",createdAt:Date.now(),content:"بص يا بطل — اسألني أي سؤال في الدرس وأنا هجاوبك من الكتاب نفسه."}],[c,i]=o.useState(!1),[r,u]=o.useState(!1),[g,y]=o.useState(""),[S,U]=o.useState(()=>{const h=he(localStorage.getItem($({userId:d,fileId:f})));return h&&h.length?h:w});o.useEffect(()=>{try{localStorage.setItem($({userId:d,fileId:f}),JSON.stringify(S.slice(-200)))}catch{}},[S,d,f]);const N=o.useCallback(h=>{U(k=>[...k,{id:`m_${Math.random().toString(16).slice(2)}_${Date.now()}`,createdAt:Date.now(),...h}])},[]),I=o.useCallback(async(h,k)=>{if(!V()){p.error("الذكاء الاصطناعي غير مُفعل حالياً");return}u(!0);try{N({role:"user",content:k||`/${h}`});const F=h==="اربط بملف قديم",B=F&&n?m?(await ae(n,{excludeFileId:a,maxFiles:8})).map(C=>({fileName:C.fileName,summary:C.summary})):se({user:n,excludeFileId:a,perFileChars:1500,maxFiles:8}).map(C=>({fileName:C.fileName,summary:C.summary})):void 0,G=await de({socratic:x,commandLabel:h,userMessage:k,pageMarkdown:a?"":t,fileId:a,globalSummaries:B,mode:F?"cross-file":"normal",study_mode:l});N({role:"assistant",content:G})}catch{p.error("فشل الاتصال بالذكاء الاصطناعي"),N({role:"assistant",content:"حصلت مشكلة بسيطة. جرّب تاني بعد ثواني."})}finally{u(!1)}},[m,n,a,t,N,x,l]),P=o.useCallback(async()=>{const h=g.trim();h&&(y(""),await I("سؤال عام",h))},[g,I]);return{chatOpen:c,setChatOpen:i,chatLoading:r,draft:g,setDraft:y,messages:S,runCommand:I,sendDraft:P}}const ye=o.memo(function(a){return a.open?e.jsxs(E,{className:"border bg-background",children:[e.jsxs(A,{className:"pb-3 flex-row items-center justify-between",children:[e.jsx(D,{className:"text-lg",children:"المساعد الدراسي"}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>a.onOpenChange(!1),children:"إغلاق"})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsx(le,{className:"h-[340px] rounded-xl border bg-secondary/10 p-3",children:e.jsxs("div",{className:"space-y-3","data-source":"src/components/explain/StudyChatView.tsx:34:11",children:[a.messages.map(t=>e.jsxs("div",{className:O("rounded-xl border p-3 text-sm leading-7",t.role==="user"?"bg-background":"bg-primary/5 border-primary/20"),"data-source":"src/components/explain/StudyChatView.tsx:36:15",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1","data-source":"src/components/explain/StudyChatView.tsx:43:17",children:t.role==="user"?"أنت":"Academic AI"}),e.jsx("div",{className:"whitespace-pre-wrap","data-source":"src/components/explain/StudyChatView.tsx:46:17",children:t.content})]},t.id)),a.loading?e.jsx("div",{className:"text-sm text-muted-foreground","data-source":"src/components/explain/StudyChatView.tsx:50:15",children:"جاري الرد..."}):null]})}),Array.isArray(a.suggestions)&&a.suggestions.length?e.jsx("div",{className:"flex flex-wrap gap-2","data-source":"src/components/explain/StudyChatView.tsx:56:11",children:a.suggestions.slice(0,6).map(t=>e.jsx("button",{type:"button",disabled:a.loading,onClick:()=>a.onPickSuggestion?.(t),className:O("text-xs sm:text-sm","rounded-full border px-3 py-1","bg-secondary/20 hover:bg-secondary/35 transition","disabled:opacity-60 disabled:cursor-not-allowed"),"data-source":"src/components/explain/StudyChatView.tsx:58:15",children:t},t))}):null,e.jsxs("div",{className:"flex items-center gap-2","data-source":"src/components/explain/StudyChatView.tsx:76:9",children:[e.jsx(te,{value:a.draft,onChange:t=>a.onDraftChange(t.target.value),placeholder:"اكتب سؤالك هنا...",disabled:a.loading,onKeyDown:t=>{t.key==="Enter"&&a.onSend()}}),e.jsxs(j,{className:"gap-2",onClick:a.onSend,disabled:a.loading||!a.draft.trim(),children:[e.jsx(W,{className:"size-4"}),"إرسال"]})]}),e.jsx("div",{className:"text-xs text-muted-foreground","data-source":"src/components/explain/StudyChatView.tsx:92:9",children:"*ملاحظة: في وضع RAG، الرد يعتمد على الفقرات المسترجعة من الملف.*"})]})]}):null});function je(s){return e.jsxs(e.Fragment,{children:[e.jsxs(j,{variant:"outline",className:"gap-2",onClick:s.onToggle,children:[e.jsx(q,{className:"size-4"}),s.open?"إغلاق الشات":"فتح الشات"]}),e.jsx(ye,{open:s.open,onOpenChange:a=>{a||s.onToggle()},loading:s.loading,messages:s.messages,draft:s.draft,onDraftChange:s.onDraftChange,onSend:s.onSend,suggestions:s.suggestions,onPickSuggestion:s.onPickSuggestion})]})}const Se=o.lazy(()=>T(()=>import("./StudyMindMap-ClTJ6Msu.js").then(s=>s.b5),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url));function be(s){return e.jsxs(E,{children:[e.jsx(A,{className:"pb-3",children:e.jsx(D,{className:"text-lg",children:"الخريطة الذهنية"})}),e.jsxs(L,{className:"space-y-3",children:[e.jsxs("div",{className:"grid gap-2","data-source":"src/components/explain/MindMapViewer.tsx:27:9",children:[e.jsxs(j,{className:"w-full gap-2",variant:s.mindmapCode?"secondary":"default",onClick:()=>s.onBuild(),disabled:s.mindmapLoading||s.aiDisabled||!s.fileId,children:[e.jsx(K,{className:"size-4"}),s.mindmapLoading?"جاري التوليد...":s.mindmapCode?"إظهار/إعادة تحميل":"توليد خريطة ذهنية"]}),s.mindmapCode?e.jsxs(j,{className:"w-full gap-2",variant:"default",onClick:()=>s.onBuild({refresh:!0}),disabled:s.mindmapLoading||s.aiDisabled||!s.fileId,children:[e.jsx(J,{className:"size-4"}),"تحديث الخريطة"]}):null]}),s.mindmapCode?e.jsxs("div",{className:"grid gap-2","data-source":"src/components/explain/MindMapViewer.tsx:56:11",children:[e.jsxs("div",{className:"flex items-center gap-2","data-source":"src/components/explain/MindMapViewer.tsx:57:13",children:[e.jsxs(j,{size:"sm",variant:"outline",className:"w-full gap-2",onClick:s.onCopyCode,children:[e.jsx(X,{className:"size-4"}),"نسخ الكود"]}),e.jsxs(j,{size:"sm",variant:"outline",className:"w-full gap-2",onClick:s.onDownload,children:[e.jsx(Y,{className:"size-4"}),"تحميل"]})]}),e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"text-sm text-muted-foreground","data-source":"src/components/explain/MindMapViewer.tsx:68:39",children:"جاري تحميل العارض..."}),children:e.jsx(Se,{code:s.mindmapCode})})]}):e.jsx("div",{className:"text-sm text-muted-foreground leading-6","data-source":"src/components/explain/MindMapViewer.tsx:73:11",children:"اضغط على زر التوليد لاستخراج هيكل الدرس في صورة Mind Map."})]})]})}const Ce=o.lazy(()=>T(()=>import("./MarkdownView-N1CXs6cB.js"),__vite__mapDeps([7,1,8]),import.meta.url)),Ne=o.memo(function(a){return e.jsx(o.Suspense,{fallback:e.jsx("div",{className:"p-4","data-source":"src/components/explain/ExplanationRenderer.tsx:14:9",children:e.jsx(me,{label:"جاري تحميل العارض...",size:"sm"})}),children:e.jsx(Ce,{markdown:a.markdown,components:a.components})})});function ke(){return e.jsxs("div",{className:"space-y-3","data-source":"src/components/explain/ContentArea.tsx:18:5",children:[e.jsx(b,{className:"h-6 w-2/3"}),e.jsx(b,{className:"h-4 w-full"}),e.jsx(b,{className:"h-4 w-11/12"}),e.jsx(b,{className:"h-4 w-10/12"}),e.jsx(b,{className:"h-4 w-9/12"}),e.jsx("div",{className:"pt-2","data-source":"src/components/explain/ContentArea.tsx:24:7",children:e.jsx(b,{className:"h-24 w-full"})})]})}function Ie(s){return e.jsxs(E,{className:"min-w-0",children:[e.jsx(A,{className:"pb-3",children:e.jsx(D,{className:"text-xl",children:s.title||"محتوى الشرح"})}),e.jsxs(L,{children:[e.jsx("article",{className:"prose prose-zinc max-w-none dark:prose-invert","data-source":"src/components/explain/ContentArea.tsx:38:9",children:s.mode==="loading"?e.jsx(ke,{}):e.jsx(Ne,{markdown:s.markdown,components:s.mdComponents})}),e.jsx("div",{className:"mt-6","data-source":"src/components/explain/ContentArea.tsx:47:9",children:e.jsx(M,{slot:""})})]})]})}function $e(){const[,s]=ne(),a=ie(),t=ge({fileIdFromRoute:String(a?.fileId||""),onInvalidFile:()=>s("/مكتبتي")}),x=pe({fileId:t.fileId,fileName:t.fileName,aiDisabled:t.mode==="missing-ai"}),l=sessionStorage.getItem("aass:study_mode")||"balanced",n=o.useMemo(()=>{const f=["هل تريد تلخيصاً لأهم النقاط؟","اعمل لي أسئلة تدريب سريعة من الدرس","اشرح لي هذه الفكرة ببساطة","اذكر أهم التعريفات والقوانين"],c=String(t.markdown||"").split(`
`).filter(i=>/^#{1,3}\s+/.test(i)).map(i=>i.replace(/^#{1,3}\s+/,"").trim()).filter(i=>i.length).slice(0,4).map(i=>`اشرح لي قسم: ${i}`);return Array.from(new Set([...f,...c])).slice(0,8)},[t.markdown]),m=we({fileId:t.fileId,pageMarkdown:t.markdown,socraticMode:sessionStorage.getItem("aass:socratic_mode")==="1",study_mode:l}),d=o.useMemo(()=>{let f=0,w=0;const c=5,i=2;return{p:r=>{f+=1;const u=f%c===0&&w<i;return u&&(w+=1),e.jsxs(e.Fragment,{children:[e.jsx("p",{...r,"data-source":"src/pages/Explain.tsx:73:13"}),u?e.jsx("div",{className:"my-5 not-prose","data-source":"src/pages/Explain.tsx:75:15",children:e.jsx(M,{slot:""})}):null]})}}},[t.markdown]);return e.jsx(re,{children:e.jsxs("section",{className:"mx-auto w-full max-w-6xl space-y-6","data-source":"src/pages/Explain.tsx:89:7",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-end md:justify-between","data-source":"src/pages/Explain.tsx:90:9",children:[e.jsxs("div",{className:"space-y-1","data-source":"src/pages/Explain.tsx:91:11",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-extrabold","data-source":"src/pages/Explain.tsx:92:13",children:"صفحة الشرح"}),e.jsx("p",{className:"text-muted-foreground leading-7","data-source":"src/pages/Explain.tsx:93:13",children:t.fileName})]}),e.jsxs("div",{className:"flex flex-wrap gap-2","data-source":"src/pages/Explain.tsx:96:11",children:[e.jsxs(j,{variant:"outline",className:"gap-2",onClick:t.copyExplainLink,disabled:!t.fileId,children:[e.jsx(H,{className:"size-4"}),"نسخ رابط الشرح"]}),e.jsx(je,{open:m.chatOpen,onToggle:()=>m.setChatOpen(f=>!f),loading:m.chatLoading,messages:m.messages,draft:m.draft,onDraftChange:m.setDraft,onSend:m.sendDraft,suggestions:n,onPickSuggestion:f=>{m.setChatOpen(!0),m.setDraft(f)}}),e.jsxs(j,{className:"gap-2",onClick:()=>s(t.fileId?`/بنك-الأسئلة/${t.fileId}`:"/بنك-الأسئلة"),disabled:!t.fileId,children:[e.jsx(Q,{className:"size-4"}),"توليد اختبار سريع"]})]})]}),e.jsx(oe,{}),e.jsxs("div",{className:"grid gap-5 lg:grid-cols-[1fr_22rem]","data-source":"src/pages/Explain.tsx:130:9",children:[e.jsx(Ie,{mode:t.mode,markdown:t.markdown,mdComponents:d}),e.jsxs("aside",{className:"space-y-5","data-source":"src/pages/Explain.tsx:133:11",children:[e.jsx(be,{fileId:t.fileId,aiDisabled:t.mode==="missing-ai",mindmapCode:x.mindmapCode,mindmapLoading:x.mindmapLoading,onBuild:x.buildMindMap,onCopyCode:x.copyMindMapCode,onDownload:x.downloadMindMap}),e.jsx(M,{slot:""})]})]})]})})}export{$e as default};
