const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StatsWeeklyChart-CI6VLZxI.js","./vendor-ui-ARy-o6ek.js","./vendor-charts-msDMqvam.js","./StatsSubjectsChart-Bo0ds-dh.js"])))=>i.map(i=>d[i]);
import{d as l,O as le,g as xe,i as ue,A as me,C as u,c as m,P as ge,a as y,b as _,e as pe,_ as Q}from"./index-CVOPyXAZ.js";import{j as e,H as he,r as p,J as fe,K as je,N as Se,O as be,Q as Ne}from"./vendor-ui-ARy-o6ek.js";import{L as P}from"./LoadingSpinner-BXeLHAwc.js";import{A as K}from"./AdUnit-DLxwGZFG.js";import"./vendor-charts-msDMqvam.js";import"./vendor-supabase-Djqvfl2V.js";import"./vendor-motion-D4ajpNSI.js";const ve=le("inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function ye({className:a,variant:c,asChild:i=!1,...d}){const x=i?he:"span";return e.jsx(x,{"data-slot":"badge",className:l(ve({variant:c}),a),...d})}const _e=p.lazy(()=>Q(()=>import("./StatsWeeklyChart-CI6VLZxI.js"),__vite__mapDeps([0,1,2]),import.meta.url)),we=p.lazy(()=>Q(()=>import("./StatsSubjectsChart-Bo0ds-dh.js"),__vite__mapDeps([3,1,2]),import.meta.url)),g="dark:bg-white/10 dark:backdrop-blur-md dark:border-white/10";function ke(a){return`${a.toFixed(1)} ساعة`}function Ae(a){return["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][a.getDay()]||""}function Y(a){return new Date(a.getFullYear(),a.getMonth(),a.getDate())}const w=[{key:"starter",name:"مبتدئ",minXp:0,badgeVariant:"secondary"},{key:"focused",name:"مجتهد",minXp:500,badgeVariant:"outline"},{key:"pro",name:"محترف",minXp:1500,badgeVariant:"default"},{key:"elite",name:"نخبة",minXp:3500,badgeVariant:"default"},{key:"legend",name:"أسطورة",minXp:7e3,badgeVariant:"destructive"}];function De(a){const c=Math.max(0,Number(a||0));let i=w[0];for(const j of w)c>=j.minXp&&(i=j);const d=w.findIndex(j=>j.key===i.key),x=d>=0&&d<w.length-1?w[d+1]:null,f=x?x.minXp:null,h=f?Math.min(100,Math.max(0,(c-i.minXp)/Math.max(1,f-i.minXp)*100)):100;return{current:i,next:x,nextXp:f,progress:h,xp:c}}function F(a){const c=Y(a),i=c.getFullYear(),d=String(c.getMonth()+1).padStart(2,"0"),x=String(c.getDate()).padStart(2,"0");return`${i}-${d}-${x}`}function Fe(){const a=xe(),c=pe(),[i,d]=p.useState(!0),[x,f]=p.useState(""),[h,j]=p.useState({totalStudyHours30d:0,avgScore10:0,answeredQuestions:0,processedFiles:0,xp:0,level:1,coins:0}),[W,G]=p.useState([]),[J,Z]=p.useState([]),[V,ee]=p.useState("");return p.useEffect(()=>{if(!a||!c){d(!1);return}const n=ue();if(!n){d(!1);return}let k=!0;return(async()=>{d(!0),f("");try{let A=0,q=1,L=0,R=[],I=[];try{const{data:s,error:t}=await n.from("user_stats").select("xp,total_xp,current_level,coins,weak_topics,strong_topics").eq("user_id",a.id).maybeSingle();!t&&s&&(A=Number(s.xp??s.total_xp??0)||0,q=Number(s.current_level||1)||1,L=Number(s.coins||0)||0,R=Array.isArray(s.weak_topics)?s.weak_topics.map(String):[],I=Array.isArray(s.strong_topics)?s.strong_topics.map(String):[])}catch{}const{count:se}=await n.from("files").select("id",{count:"exact",head:!0}).eq("user_id",a.id),{data:te}=await n.from("quizzes").select("score,total,created_at").eq("user_id",a.id).order("created_at",{ascending:!1}).limit(50),D=te||[],ae=D.reduce((s,t)=>s+(Number(t?.total)||0),0),z=new Date,re=new Date(z.getTime()-720*60*60*1e3),ce=new Date(z.getTime()-336*60*60*1e3),{data:ne}=await n.from("exam_attempts").select("created_at,score,total,exam_id").eq("user_id",a.id).gte("created_at",re.toISOString()).order("created_at",{ascending:!0}).limit(500),S=ne||[],O=Array.from(new Set(S.map(s=>String(s.exam_id||"")).filter(Boolean))),b=new Map;if(O.length){const{data:s}=await n.from("exams").select("id,duration_sec").eq("user_id",a.id).in("id",O);for(const t of s||[])b.set(String(t.id),Number(t.duration_sec||0))}const H=Array.from({length:7}).map((s,t)=>{const r=new Date(z.getTime()-(6-t)*24*60*60*1e3);return Y(r)}),C=new Map(H.map(s=>[F(s),0]));for(const s of S){const t=s.created_at?new Date(String(s.created_at)):null;if(!t)continue;const r=F(t);if(!C.has(r))continue;const o=b.get(String(s.exam_id||""))||0,v=o?o/60:15;C.set(r,(C.get(r)||0)+v)}const ie=H.map(s=>{const t=F(s),r=Math.round(C.get(t)||0);return{day:Ae(s),minutes:r,hours:Number((r/60).toFixed(2))}}),de=S.reduce((s,t)=>{const r=b.get(String(t.exam_id||""))||0;return s+(r?r/60:15)},0),X=S.slice(-10),oe=X.length?Math.round(X.reduce((s,t)=>{const r=Number(t.score||0),o=Number(t.total||0)||1;return s+r/o*100},0)/X.length||0):D.length?Math.round(D.slice(0,10).reduce((s,t)=>{const r=Number(t?.score||0),o=Number(t?.total||0)||1;return s+r/o*100},0)/Math.min(10,D.length)||0):0,U=S.filter(s=>{const t=s.created_at?new Date(String(s.created_at)):null;return t?t>=ce:!1}),B=new Date(z.getTime()-10080*60*1e3),$=U.reduce((s,t)=>{const r=new Date(String(t.created_at)),o=b.get(String(t.exam_id||""))||0,v=o?o/60:15;return r>=B?s+v:s},0),M=U.reduce((s,t)=>{const r=new Date(String(t.created_at)),o=b.get(String(t.exam_id||""))||0,v=o?o/60:15;return r<B?s+v:s},0);let T="";if($>=120){const s=M?Math.round(($-M)/Math.max(1,M)*100):100;M===0?T="بداية قوية! واضح إنك نشّطت مذاكرتك خلال آخر 7 أيام. كمل بنفس النسق.":s>=15&&(T=`تقدّم ملحوظ! زودت وقت مذاكرتك خلال آخر 7 أيام بنسبة حوالي ${s}% عن الأسبوع اللي قبله.`)}const N=[],E=new Set;for(const s of I.slice(0,6)){const t=String(s).trim();!t||E.has(t)||(E.add(t),N.push({subject:t,level:85}))}for(const s of R.slice(0,6)){const t=String(s).trim();!t||E.has(t)||(E.add(t),N.push({subject:t,level:55}))}if(N.length||N.push({subject:"(لا توجد بيانات موضوعات بعد)",level:0}),!k)return;j({totalStudyHours30d:Number((de/60).toFixed(1)),avgScore10:oe,answeredQuestions:ae,processedFiles:Number(se||0),xp:A,level:q,coins:L}),G(ie),Z(N),ee(T)}catch(A){if(!k)return;f(String(A?.message||"تعذر تحميل الإحصائيات"))}finally{if(!k)return;d(!1)}})(),()=>{k=!1}},[a?.id,c]),e.jsx(me,{children:e.jsxs("section",{className:"mx-auto w-full max-w-6xl space-y-6","data-source":"src/pages/Stats.tsx:331:7",children:[e.jsxs("div",{className:"space-y-2","data-source":"src/pages/Stats.tsx:332:9",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-extrabold","data-source":"src/pages/Stats.tsx:333:11",children:"الإحصائيات المركزية"}),e.jsx("p",{className:"text-muted-foreground leading-7","data-source":"src/pages/Stats.tsx:334:11",children:"لوحة تحكم حقيقية مرتبطة بحسابك على Supabase."})]}),!a&&e.jsx(u,{className:l(g),children:e.jsxs(m,{className:"pt-6 space-y-2",children:[e.jsx("div",{className:"font-extrabold","data-source":"src/pages/Stats.tsx:342:15",children:"سجّل دخولك أولاً"}),e.jsx("div",{className:"text-sm text-muted-foreground leading-7","data-source":"src/pages/Stats.tsx:343:15",children:"الإحصائيات تعتمد على بياناتك السحابية."})]})}),a&&!c&&e.jsx(u,{className:l(g),children:e.jsxs(m,{className:"pt-6 space-y-2",children:[e.jsx("div",{className:"font-extrabold","data-source":"src/pages/Stats.tsx:353:15",children:"السحابة غير مفعلة"}),e.jsx("div",{className:"text-sm text-muted-foreground leading-7","data-source":"src/pages/Stats.tsx:354:15",children:"فعّل Supabase (VITE_SUPABASE_URL و VITE_SUPABASE_ANON_KEY) لعرض إحصائيات حقيقية."})]})}),a&&c&&i&&e.jsx(u,{className:l(g),children:e.jsx(m,{className:"pt-6",children:e.jsx(P,{label:"جاري تحميل الإحصائيات..."})})}),a&&c&&!i&&x&&e.jsx(u,{className:l(g),children:e.jsxs(m,{className:"pt-6 space-y-2",children:[e.jsx("div",{className:"font-extrabold","data-source":"src/pages/Stats.tsx:372:15",children:"تعذر تحميل الإحصائيات"}),e.jsx("div",{className:"text-sm text-muted-foreground","data-source":"src/pages/Stats.tsx:373:15",children:x})]})}),a&&c&&!i&&!x&&e.jsxs(e.Fragment,{children:[V?e.jsx(u,{className:l(g),children:e.jsxs(m,{className:"pt-6 flex items-start gap-3",children:[e.jsx("div",{className:"size-10 rounded-xl bg-secondary grid place-items-center","data-source":"src/pages/Stats.tsx:383:19",children:e.jsx(fe,{className:"size-5"})}),e.jsxs("div",{"data-source":"src/pages/Stats.tsx:386:19",children:[e.jsx("div",{className:"font-extrabold","data-source":"src/pages/Stats.tsx:387:21",children:"أداء ممتاز"}),e.jsx("div",{className:"text-sm text-muted-foreground leading-7 mt-1","data-source":"src/pages/Stats.tsx:388:21",children:V})]})]})}):null,(()=>{const n=De(h.xp);return e.jsx(u,{className:l(g),children:e.jsxs(m,{className:"pt-6 space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3","data-source":"src/pages/Stats.tsx:400:21",children:[e.jsx("div",{className:"size-10 rounded-xl bg-secondary grid place-items-center","data-source":"src/pages/Stats.tsx:401:23",children:e.jsx(je,{className:"size-5"})}),e.jsxs("div",{className:"flex-1","data-source":"src/pages/Stats.tsx:404:23",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2","data-source":"src/pages/Stats.tsx:405:25",children:[e.jsx("div",{className:"font-extrabold","data-source":"src/pages/Stats.tsx:406:27",children:"رتبتك الحالية"}),e.jsx(ye,{variant:n.current.badgeVariant,children:n.current.name})]}),e.jsxs("div",{className:"text-sm text-muted-foreground leading-7 mt-1","data-source":"src/pages/Stats.tsx:409:25",children:["XP: ",e.jsx("span",{className:"font-bold text-foreground","data-source":"src/pages/Stats.tsx:410:31",children:n.xp}),n.next?e.jsxs(e.Fragment,{children:[" ","• التالي: ",e.jsx("span",{className:"font-bold text-foreground","data-source":"src/pages/Stats.tsx:413:46",children:n.next.name})," عند ",n.next.minXp," XP"]}):e.jsxs(e.Fragment,{children:[" ","• وصلت لأعلى رتبة حالياً"]})]})]})]}),e.jsx(ge,{value:n.progress}),n.next?e.jsxs("div",{className:"text-xs text-muted-foreground","data-source":"src/pages/Stats.tsx:427:23",children:["المتبقي: ",Math.max(0,n.next.minXp-n.xp)," XP"]}):null]})})})(),e.jsx(K,{slot:""}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3","data-source":"src/pages/Stats.tsx:440:13",children:[e.jsxs(u,{className:l(g),children:[e.jsxs(y,{className:"flex-row items-start justify-between space-y-0 pb-2",children:[e.jsxs("div",{"data-source":"src/pages/Stats.tsx:443:19",children:[e.jsx(_,{className:"text-base",children:"إجمالي ساعات المذاكرة"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:445:21",children:"آخر 30 يوم (تقريبي)"})]}),e.jsx("div",{className:"size-10 rounded-xl bg-secondary grid place-items-center","data-source":"src/pages/Stats.tsx:447:19",children:e.jsx(Se,{className:"size-5"})})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-3xl font-extrabold","data-source":"src/pages/Stats.tsx:452:19",children:ke(h.totalStudyHours30d)}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:453:19",children:"من سجلات محاولات الامتحان"})]})]}),e.jsxs(u,{className:l(g),children:[e.jsxs(y,{className:"flex-row items-start justify-between space-y-0 pb-2",children:[e.jsxs("div",{"data-source":"src/pages/Stats.tsx:459:19",children:[e.jsx(_,{className:"text-base",children:"متوسط الدرجات"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:461:21",children:"آخر 10 محاولات"})]}),e.jsx("div",{className:"size-10 rounded-xl bg-secondary grid place-items-center","data-source":"src/pages/Stats.tsx:463:19",children:e.jsx(be,{className:"size-5"})})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-3xl font-extrabold","data-source":"src/pages/Stats.tsx:468:19",children:[h.avgScore10,"%"]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:469:19",children:"من exam_attempts (أو quizzes كبديل)"})]})]}),e.jsxs(u,{className:l(g),children:[e.jsxs(y,{className:"flex-row items-start justify-between space-y-0 pb-2",children:[e.jsxs("div",{"data-source":"src/pages/Stats.tsx:475:19",children:[e.jsx(_,{className:"text-base",children:"عدد الأسئلة المُجابة"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:477:21",children:"إجمالي (quizzes)"})]}),e.jsx("div",{className:"size-10 rounded-xl bg-secondary grid place-items-center","data-source":"src/pages/Stats.tsx:479:19",children:e.jsx(Ne,{className:"size-5"})})]}),e.jsxs(m,{children:[e.jsx("div",{className:"text-3xl font-extrabold","data-source":"src/pages/Stats.tsx:484:19",children:h.answeredQuestions}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:485:19",children:["ملفات: ",h.processedFiles," • Level: ",h.level," • XP: ",h.xp," • Coins: ",h.coins]})]})]})]}),e.jsxs("div",{className:"grid gap-5 lg:grid-cols-2","data-source":"src/pages/Stats.tsx:491:13",children:[e.jsxs(u,{className:l(g),children:[e.jsxs(y,{className:"pb-2",children:[e.jsx(_,{className:"text-lg",children:"نشاط المذاكرة الأسبوعي"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:495:19",children:"من مدة الامتحانات (أو تقدير 15 دقيقة لكل محاولة)"})]}),e.jsx(m,{children:e.jsx(p.Suspense,{fallback:e.jsx("div",{className:"h-72 grid place-items-center","data-source":"src/pages/Stats.tsx:500:23",children:e.jsx(P,{label:"جاري تحميل الرسم..."})}),children:e.jsx(_e,{weekly:W})})})]}),e.jsxs(u,{className:l(g),children:[e.jsxs(y,{className:"pb-2",children:[e.jsx(_,{className:"text-lg",children:"نقاط القوة/الضعف حسب الموضوع"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1","data-source":"src/pages/Stats.tsx:513:19",children:"من user_stats (weak_topics/strong_topics)"})]}),e.jsx(m,{children:e.jsx(p.Suspense,{fallback:e.jsx("div",{className:"h-72 grid place-items-center","data-source":"src/pages/Stats.tsx:518:23",children:e.jsx(P,{label:"جاري تحميل الرسم..."})}),children:e.jsx(we,{subjects:J})})})]})]}),e.jsx(K,{slot:""})]})]})})}export{Fe as default};
