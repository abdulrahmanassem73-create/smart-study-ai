const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./MarkdownView-N1CXs6cB.js","./vendor-ui-ARy-o6ek.js","./vendor-markdown-PAa2EYla.js"])))=>i.map(i=>d[i]);
import{u as ts,D as rs,g as V,i as ns,e as W,t as d,d as G,B as m,C as w,a as N,b as E,c as S,P as is,S as J,_ as cs}from"./index-CVOPyXAZ.js";import{r,j as s,v as ds,P as ls,w as os,D as K}from"./vendor-ui-ARy-o6ek.js";import{A as ms}from"./AdUnit-DLxwGZFG.js";import{g as xs}from"./gemini-study-pack-CLczGIFe.js";import{s as us,g as ps}from"./gemini-chat-CizPHIUd.js";import"./vendor-charts-msDMqvam.js";import"./vendor-supabase-Djqvfl2V.js";import"./vendor-motion-D4ajpNSI.js";const gs=r.lazy(()=>cs(()=>import("./MarkdownView-N1CXs6cB.js"),__vite__mapDeps([0,1,2]),import.meta.url));function hs(u){const g=Math.max(0,Math.floor(u)),i=String(Math.floor(g/60)).padStart(2,"0"),h=String(g%60).padStart(2,"0");return`${i}:${h}`}function Ss(){const[,u]=ts(),g=rs(),i=r.useMemo(()=>{const e=String(g?.fileId||"").trim(),t=sessionStorage.getItem("aass:active_file_id")||"",a=e||t;return e&&e!==t&&sessionStorage.setItem("aass:active_file_id",e),a},[g?.fileId]),[h,Q]=r.useState(sessionStorage.getItem("aass:last_uploaded_file_name")||"(ملف غير محدد)"),[f,v]=r.useState(!1);r.useEffect(()=>{if(!i)return;const e=V(),t=ns();!e||!W()||!t||(async()=>{try{const{data:a,error:o}=await t.from("files").select("id,name").eq("user_id",e.id).eq("id",i).maybeSingle();try{await t.from("files").update({last_opened_at:new Date().toISOString()}).eq("user_id",e.id).eq("id",i)}catch{}if(o)throw o;if(!a)throw new Error("FILE_NOT_FOUND");const y=String(a.name||"(ملف)");Q(y),sessionStorage.setItem("aass:last_uploaded_file_name",y)}catch(a){console.error(a),d.error("الرابط غير صالح أو الملف غير موجود"),u("/مكتبتي")}})()},[i]);const[n,X]=r.useState(null),[j,A]=r.useState([]),[_,k]=r.useState(0),[p,P]=r.useState(0),[l,$]=r.useState(!1),[q,D]=r.useState(""),[F,T]=r.useState(null),[Y,M]=r.useState(null),[C,z]=r.useState([]),[b,L]=r.useState([]),[I,O]=r.useState([]),x=n?.questions?.[Math.min(_,(n?.questions?.length||1)-1)]||null;r.useEffect(()=>{if(!n||l||p<=0)return;const e=window.setInterval(()=>{P(t=>t-1)},1e3);return()=>window.clearInterval(e)},[n,p,l]),r.useEffect(()=>{n&&(l||p>0||n&&j.length&&H(!0))},[p]);const R=async()=>{if(!V()||!W()){d.error("لازم تسجل دخول عشان وضع الامتحان"),u("/auth");return}if(!xs()){d.error("الذكاء الاصطناعي غير مُفعل حالياً");return}if(!i){d.error("اختار ملف من المكتبة/ارفع ملف أولاً"),u("/مكتبتي");return}v(!0),$(!1),D(""),T(null),M(null),z([]),L([]),O([]);try{const t=await ps({fileId:i,title:`امتحان: ${h}`,questionCount:15,durationSec:1800});X(t),A(t.questions.map(a=>({id:a.id,selectedIndex:null}))),k(0),P(t.durationSec),d.success("تم توليد الامتحان")}catch{d.error("فشل توليد الامتحان")}finally{v(!1)}},Z=(e,t)=>{l||A(a=>a.map(o=>o.id===e?{...o,selectedIndex:t}:o))},U=j.filter(e=>e.selectedIndex!==null).length,B=n?Math.round(U/n.questions.length*100):0,H=async(e=!1)=>{if(!n||l)return;const t=j.filter(a=>a.selectedIndex===null).length;if(!e&&t>0){d.error("لازم تجاوب على كل الأسئلة قبل التسليم");return}v(!0);try{const a=await us({examId:n.examId,fileId:i,answers:j});$(!0),T(a.score),M(a.total),D(a.report_markdown||""),z(Array.isArray(a.wrong_items)?a.wrong_items:[]),L(Array.isArray(a.study_plan)?a.study_plan:[]),O(Array.isArray(a.weak_topics)?a.weak_topics.map(String):[]),d.success("تم تصحيح الامتحان وإنشاء تقرير الأداء")}catch{d.error("فشل تصحيح الامتحان")}finally{v(!1)}},ss=()=>{d.message("سيتم فتح نافذة الطباعة — اختر Save as PDF"),window.print()},es=()=>{const e=window.open("","_blank","noopener,noreferrer");if(!e){d.error("تعذر فتح نافذة جديدة لإنشاء PDF");return}const t=I.length?I:Array.from(new Set(C.map(c=>String(c?.topic||"").trim()).filter(Boolean))),a=C.slice(0,30).map(c=>`
          <div class="card">
            <div class="title">${String(c.topic||"موضوع")} <span class="muted">(${String(c.id||"")})</span></div>
            <div><b>لماذا أخطأت:</b> ${String(c.why_wrong||"")}</div>
            <div><b>ما الذي تراجعه:</b> ${String(c.what_to_review||"")}</div>
            <div class="quote">"${String(c.reference_quote||"")}"</div>
          </div>
        `).join(`
`),o=Array.isArray(b)&&b.length?`<div class="card"><div class="title">خطة مراجعة مختصرة</div><ul>${b.slice(0,10).map(c=>`<li>${String(c)}</li>`).join("")}</ul></div>`:"",y=t.length?`<div class="card"><div class="title">الموضوعات الأضعف</div><div class="tags">${t.slice(0,12).map(c=>`<span class="tag">${c}</span>`).join("")}</div></div>`:"",as=`
      <!doctype html>
      <html lang="ar" dir="rtl">
        <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <title>ملخص الأخطاء الشائعة</title>
          <style>
            body { font-family: "Almarai", Arial, sans-serif; padding: 24px; }
            h1,h2 { font-family: "Changa", Arial, sans-serif; margin: 0 0 12px; }
            .muted { color: #666; }
            .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
            .title { font-weight: 800; margin-bottom: 8px; }
            .quote { margin-top: 8px; padding: 10px; border-right: 4px solid #999; background: #fafafa; color: #333; }
            ul { margin: 8px 0 0; padding: 0 18px 0 0; }
            li { margin: 6px 0; }
            .tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
            .tag { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; font-size: 12px; background: #f6f6f6; }
            @media print { a { display: none; } }
          </style>
          <link rel="preconnect" href="https://fonts.googleapis.com" />
          <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
          <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Changa:wght@400;600;700;800&display=swap" rel="stylesheet" />
        </head>
        <body>
          <h1>ملخص الأخطاء الشائعة</h1>
          <div class="muted">${h} • ${new Date().toLocaleDateString("ar-EG")}</div>

          ${y}
          ${o}

          <h2>تفاصيل الأخطاء</h2>
          ${a||'<div class="muted">لا توجد أخطاء مسجلة.</div>'}

          <script>
            setTimeout(() => { window.print(); }, 250);
          <\/script>
        </body>
      </html>
    `;e.document.open(),e.document.write(as),e.document.close()};return s.jsxs("div",{className:"min-h-screen bg-background","data-source":"src/pages/Exam.tsx:316:5",children:[s.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur print:hidden","data-source":"src/pages/Exam.tsx:318:7",children:s.jsxs("div",{className:"mx-auto max-w-5xl px-4 py-3 flex items-center justify-between gap-3","data-source":"src/pages/Exam.tsx:319:9",children:[s.jsxs("div",{className:"min-w-0","data-source":"src/pages/Exam.tsx:320:11",children:[s.jsx("div",{className:"font-extrabold truncate","data-source":"src/pages/Exam.tsx:321:13",children:"وضع الامتحان"}),s.jsx("div",{className:"text-xs text-muted-foreground truncate","data-source":"src/pages/Exam.tsx:322:13",children:h})]}),s.jsxs("div",{className:"flex items-center gap-2","data-source":"src/pages/Exam.tsx:324:11",children:[n?s.jsxs("div",{className:G("rounded-full border px-3 py-1 text-sm font-bold",p<=60?"text-destructive border-destructive/40":""),title:"الوقت المتبقي","data-source":"src/pages/Exam.tsx:326:15",children:[s.jsx(ds,{className:"inline size-4 ml-1"}),hs(p)]}):null,s.jsx(m,{variant:"outline",onClick:()=>u(i?`/explain/${i}`:"/شرح"),children:"عودة"})]})]})}),s.jsx("main",{className:"mx-auto max-w-5xl px-4 py-6 space-y-5","data-source":"src/pages/Exam.tsx:343:7",children:n?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"grid gap-4 md:grid-cols-[1fr_18rem]","data-source":"src/pages/Exam.tsx:361:13",children:[s.jsxs(w,{className:"min-w-0",children:[s.jsx(N,{className:"pb-3",children:s.jsx(E,{className:"text-lg",children:"الأسئلة"})}),s.jsxs(S,{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between gap-3","data-source":"src/pages/Exam.tsx:367:19",children:[s.jsxs("div",{className:"text-sm text-muted-foreground","data-source":"src/pages/Exam.tsx:368:21",children:["تم الإجابة على: ",s.jsx("span",{className:"font-bold text-foreground","data-source":"src/pages/Exam.tsx:369:39",children:U})," / ",n.questions.length]}),s.jsxs("div",{className:"text-sm font-bold","data-source":"src/pages/Exam.tsx:371:21",children:[B,"%"]})]}),s.jsx(is,{value:B}),x?s.jsxs("div",{className:"space-y-3","data-source":"src/pages/Exam.tsx:376:21",children:[s.jsxs("div",{className:"text-xs text-muted-foreground","data-source":"src/pages/Exam.tsx:377:23",children:["المستوى: ",s.jsx("span",{className:"font-bold","data-source":"src/pages/Exam.tsx:378:34",children:x.level})," — الموضوع: ",s.jsx("span",{className:"font-bold","data-source":"src/pages/Exam.tsx:378:90",children:x.topic})]}),s.jsx("div",{className:"text-base font-extrabold leading-7","data-source":"src/pages/Exam.tsx:380:23",children:x.question}),s.jsx("div",{className:"grid gap-2","data-source":"src/pages/Exam.tsx:382:23",children:x.options.map((e,t)=>{const a=j.find(o=>o.id===x.id)?.selectedIndex===t;return s.jsxs("button",{type:"button",disabled:l,onClick:()=>Z(x.id,t),className:G("text-right rounded-xl border px-3 py-3","hover:bg-accent transition",a?"border-primary bg-primary/5":""),"data-source":"src/pages/Exam.tsx:386:29",children:[s.jsxs("span",{className:"font-bold","data-source":"src/pages/Exam.tsx:397:31",children:[t+1,") "]}),e]},t)})}),s.jsxs("div",{className:"flex items-center justify-between pt-2 gap-2","data-source":"src/pages/Exam.tsx:404:23",children:[s.jsx(m,{variant:"outline",onClick:()=>k(e=>Math.max(0,e-1)),disabled:_===0,children:"السابق"}),s.jsx(m,{variant:"outline",onClick:()=>k(e=>Math.min(n.questions.length-1,e+1)),disabled:_>=n.questions.length-1,children:"التالي"})]}),s.jsx(J,{}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 print:hidden","data-source":"src/pages/Exam.tsx:423:23",children:[s.jsxs(m,{className:"gap-2",onClick:()=>H(!1),disabled:f||l,children:[s.jsx(os,{className:"size-4"}),f?"جاري التصحيح...":l?"تم التسليم":"تسليم الامتحان"]}),s.jsxs(m,{variant:"outline",className:"gap-2",onClick:ss,children:[s.jsx(K,{className:"size-4"}),"تصدير PDF"]}),s.jsx(m,{variant:"secondary",className:"gap-2",onClick:R,disabled:f,title:"توليد امتحان جديد",children:"امتحان جديد"})]}),l&&F!==null?s.jsxs("div",{className:"rounded-xl border p-3 bg-secondary/20","data-source":"src/pages/Exam.tsx:444:25",children:[s.jsxs("div",{className:"font-extrabold","data-source":"src/pages/Exam.tsx:445:27",children:["النتيجة: ",F," / ",Y]}),s.jsx("div",{className:"text-sm text-muted-foreground mt-1","data-source":"src/pages/Exam.tsx:446:27",children:"راجع تقرير الأداء بالأسفل لمعرفة سبب الأخطاء وما يجب إعادة قراءته."})]}):null]}):null]})]}),s.jsxs(w,{className:"print:hidden",children:[s.jsx(N,{className:"pb-3",children:s.jsx(E,{className:"text-lg",children:"خريطة الامتحان"})}),s.jsxs(S,{className:"space-y-2 text-sm leading-7",children:[s.jsx("div",{"data-source":"src/pages/Exam.tsx:461:19",children:"Direct: 40%"}),s.jsx("div",{"data-source":"src/pages/Exam.tsx:462:19",children:"Concept Linking: 40%"}),s.jsx("div",{"data-source":"src/pages/Exam.tsx:463:19",children:"Critical/Case: 20%"}),s.jsx(J,{}),s.jsx("div",{className:"text-muted-foreground","data-source":"src/pages/Exam.tsx:465:19",children:"*في وضع الامتحان تم إخفاء أدوات المساعدة بالكامل.*"})]})]})]}),l&&q.trim()?s.jsxs(s.Fragment,{children:[s.jsxs(w,{children:[s.jsx(N,{className:"pb-3",children:s.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2","data-source":"src/pages/Exam.tsx:476:19",children:[s.jsx(E,{className:"text-lg",children:"تقرير الأداء"}),s.jsxs(m,{variant:"outline",size:"sm",className:"gap-2 print:hidden",onClick:es,disabled:!C.length&&!b.length&&!I.length,title:"يفتح نافذة الطباعة للحفظ PDF",children:[s.jsx(K,{className:"size-4"}),"ملخص الأخطاء (PDF)"]})]})}),s.jsx(S,{children:s.jsx(r.Suspense,{fallback:s.jsx("div",{className:"p-4 text-sm text-muted-foreground","data-source":"src/pages/Exam.tsx:492:45",children:"جاري تحميل العارض..."}),children:s.jsx(gs,{markdown:q,components:{}})})})]}),s.jsx("div",{className:"mt-5 print:hidden","data-source":"src/pages/Exam.tsx:499:15",children:s.jsx(ms,{slot:""})})]}):null]}):s.jsxs(w,{children:[s.jsx(N,{children:s.jsx(E,{children:"ابدأ امتحان جديد"})}),s.jsxs(S,{className:"space-y-4",children:[s.jsx("div",{className:"text-sm text-muted-foreground leading-7","data-source":"src/pages/Exam.tsx:350:15",children:"سيقوم النظام بتوليد امتحان مخصص بناءً على محتوى الملف ونقاط ضعفك (إن وُجدت)."}),s.jsxs(m,{className:"gap-2",onClick:R,disabled:f,children:[s.jsx(ls,{className:"size-4"}),f?"جاري التحضير...":"توليد وبدء الامتحان"]})]})]})}),s.jsx("style",{"data-source":"src/pages/Exam.tsx:509:7",children:`
        @media print {
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
      `})]})}export{Ss as default};
